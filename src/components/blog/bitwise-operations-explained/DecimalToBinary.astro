<script>
  export class DecimalToBinary extends HTMLElement {
    connectedCallback() {
      this.render();
    }

    createNumberGrid(rows, cols) {
      const grid = document.createElement('div');
      grid.className = 'font-mono text-3xl grid gap-4 justify-items-start';
      grid.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;
      grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
      return grid;
    }

    generateSteps(target) {
      const steps = [];
      let i = 1;
      for (; target / i >= 1; i *= 2) {
        steps.push({ val: i, stop: false });
      }
      steps.push({ val: i, stop: true });
      return steps;
    }

    showCalculation(number) {
      const container = document.createElement('div');
      container.className = 'text-th-primary font-mono';

      const stepsContainer = document.createElement('div');
      stepsContainer.className =
        'text-th-secondary md:max-w-[50%] py-4 grid items-center text-center gap-3';

      const steps = this.generateSteps(number);
      stepsContainer.style.gridTemplateRows = `repeat(${steps.length - 1}, minmax(0, 1fr))`;
      stepsContainer.style.gridTemplateColumns = 'repeat(5, minmax(0, 1fr))';

      steps.forEach(({ val, stop }, i) => {
        const label = document.createElement('div');
        label.innerHTML = `2<sup>${i}</sup>:`;
        stepsContainer.appendChild(label);

        const calc = document.createElement('div');
        calc.className = 'col-span-3';
        const floorResult = Math.floor(number / val);
        let content = `⌊${number} ÷ 2<sup>${i}</sup>⌋\u00A0= ${floorResult}<br />`;
        if (stop) {
          content += `<span class="font-normal text-th-primary">(<strong>STOP:</strong> ${floorResult} < 1)</span>`;
        } else {
          content += `${floorResult}\u00A0%\u00A02\u00A0=\u00A0${floorResult % 2}`;
        }
        calc.innerHTML = content;
        stepsContainer.appendChild(calc);

        const result = document.createElement('div');
        result.className = 'font-bold text-xl text-th-primary';
        if (!stop) {
          result.textContent = floorResult % 2;
        }
        stepsContainer.appendChild(result);
      });

      container.appendChild(stepsContainer);

      const instruction = document.createElement('div');
      instruction.className = 'text-sm';
      instruction.textContent = 'Re-order the bits to give the result:';
      container.appendChild(instruction);

      const gridWrapper = document.createElement('div');
      gridWrapper.className = 'py-4';

      const binaryStr = number.toString(2);
      const grid = this.createNumberGrid(2, binaryStr.length);

      // Row 1: Powers of 2
      for (let i = 0; i < binaryStr.length; i++) {
        const cell = document.createElement('div');
        cell.className = 'h-full text-sm py-2';
        cell.innerHTML = `2<sup>${binaryStr.length - (i + 1)}</sup>`;
        grid.appendChild(cell);
      }

      // Row 2: Binary digits
      for (let i = 0; i < binaryStr.length; i++) {
        const cell = document.createElement('div');
        cell.className = 'h-full';
        cell.textContent = binaryStr[i];
        grid.appendChild(cell);
      }

      gridWrapper.appendChild(grid);
      container.appendChild(gridWrapper);

      return container;
    }

    render() {
      const form = document.createElement('form');
      form.className = 'p-1 flex flex-wrap items-center gap-4';

      const input = document.createElement('input');
      input.className =
        'py-2 px-3 leading-tight shadow appearance-none focus:outline-none border rounded border-th-subtle dark:bg-th-subtle placeholder-th-tertiary dark:placeholder-th-secondary text-th-primary';
      input.type = 'number';
      input.id = 'num1';
      input.name = 'number1';
      input.required = true;
      input.placeholder = 'Enter an integer';
      input.min = '0';
      input.step = '1';

      const button = document.createElement('button');
      button.type = 'submit';
      button.className =
        'py-2 px-4 rounded font-bold focus:outline-none bg-th-action hover:bg-th-action-focus transition-all text-th-background dark:text-th-primary';
      button.textContent = 'Go';

      form.appendChild(input);
      form.appendChild(button);

      const resultContainer = document.createElement('div');

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const number = parseInt(input.value);

        resultContainer.innerHTML = '';

        if (number > 2048) {
          const error = document.createElement('div');
          error.className = 'text-th-error font-semibold';
          error.textContent = 'Please enter a number between 0 and 2048';
          resultContainer.appendChild(error);
        } else {
          resultContainer.appendChild(this.showCalculation(number));
        }
      });

      this.appendChild(form);
      this.appendChild(resultContainer);
    }
  }

  customElements.define('decimal-to-binary', DecimalToBinary);
</script>

<decimal-to-binary></decimal-to-binary>
